<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quiz Generation</title>
    <link rel="stylesheet" href="/style_quiz.css">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
</head>

<body>
    <div class="navbar">
        <div class="logo">
            <img src="/images/logo.png" alt="GAE Logo">
            <!-- <span>GAE</span> -->
        </div>
        <ul>
            <li><a href="/index.html"><i class="material-icons">home</i> Home</a></li>
            <li><a href="#"><i class="material-icons">info</i> About</a></li>
            <li><a href="#"><i class="material-icons">book</i> Courses</a></li>
            <li><a href="#"><i class="material-icons">group</i> Community</a></li>
            <li><a href="#"><i class="material-icons">email</i> Contact</a></li>
        </ul>
        <div class="search-bar">
            <input type="text" placeholder="Search...">
        </div>
        <div class="login-buttons">
            <a href="/quiz.html" class="generate-button"><i class="material-icons">sparkles</i> Generate</a>
        </div>
    </div>

    <h1>Quiz Generate</h1>
    <textarea id="prompt" placeholder="Hãy nhập chủ đề mà bạn muốn"></textarea>
    <div style="text-align: center;" id="container">
        <label for="num-questions">Max Questions:</label>
        <select id="num-questions">
            <option value="5">5</option>
            <option value="10">10</option>
            <option value="15">15</option>
            <option value="20">20</option>
            <option value="25">25</option>
            <option value="30">30</option>
            <option value="35">35</option>
            <option value="40">40</option>
            <option value="45">45</option>
            <option value="50">50</option>
        </select>
        <div style="text-align: center;">
            <button class="button1" id="submit">Submit</button>
            <button class="button1" id="get">Get</button>
        </div>
        <div class="loader" id="loading">
            Ready!
        </div>
    </div>
   <!-- TIMER -->
   <div class="timer-container" id="timer-container">
    <div class="session-buttons">
        <button class="session-button active" id="pomodoro-button" onclick="setPomodoro()">Pomodoro</button>
        <button class="session-button" id="short-break-button" onclick="setShortBreak()">Short Break</button>
        <button class="session-button" id="long-break-button" onclick="setLongBreak()">Long Break</button>
    </div>
    <div class="timer" id="timer">25:00</div>
    <button class="timer-button" id="start-button" onclick="startTimer()">START</button>
</div>
<button class="show-timer-button" onclick="toggleTimer()">Hiển thị đồng hồ</button>

<script>
    let timer;
    let timeLeft = 25 * 60;
    let sessionCount = 0;
    let isBreak = false;

    function setPomodoro() {
        clearInterval(timer);
        timeLeft = 25 * 60;
        document.getElementById('timer').innerText = '25:00';
        document.getElementById('pomodoro-button').classList.add('active');
        document.getElementById('short-break-button').classList.remove('active');
        document.getElementById('long-break-button').classList.remove('active');
        isBreak = false;
    }

    function setShortBreak() {
        clearInterval(timer);
        timeLeft = 5 * 60;
        document.getElementById('timer').innerText = '05:00';
        document.getElementById('pomodoro-button').classList.remove('active');
        document.getElementById('short-break-button').classList.add('active');
        document.getElementById('long-break-button').classList.remove('active');
        isBreak = true;
    }

    function setLongBreak() {
        clearInterval(timer);
        timeLeft = 15 * 60;
        document.getElementById('timer').innerText = '15:00';
        document.getElementById('pomodoro-button').classList.remove('active');
        document.getElementById('short-break-button').classList.remove('active');
        document.getElementById('long-break-button').classList.add('active');
        isBreak = true;
    }

    function startTimer() {
        if (timer) clearInterval(timer);
        timer = setInterval(updateTimer, 1000);
    }

    function updateTimer() {
        if (timeLeft <= 0) {
            clearInterval(timer);
            if (isBreak) {
                if (document.getElementById('short-break-button').classList.contains('active')) {
                    setPomodoro();
                } else if (document.getElementById('long-break-button').classList.contains('active')) {
                    setPomodoro();
                }
            } else {
                sessionCount++;
                if (sessionCount % 4 === 0) {
                    setLongBreak();
                } else {
                    setShortBreak();
                }
            }
            startTimer(); // Start the timer for the next session or break
        }

        let minutes = Math.floor(timeLeft / 60);
        let seconds = timeLeft % 60;
        document.getElementById('timer').innerText = `${minutes}:${seconds < 10 ? '0' : ''}${seconds}`;
        timeLeft--;
    }

    // Drag and drop functionality
    dragElement(document.getElementById("timer-container"));

    function dragElement(element) {
        let pos1 = 0, pos2 = 0, pos3 = 0, pos4 = 0;
        element.onmousedown = dragMouseDown;

        function dragMouseDown(e) {
            e = e || window.event;
            e.preventDefault();
            // Get the mouse cursor position at startup
            pos3 = e.clientX;
            pos4 = e.clientY;
            document.onmouseup = closeDragElement;
            document.onmousemove = elementDrag;
        }

        function elementDrag(e) {
            e = e || window.event;
            e.preventDefault();
            // Calculate the new cursor position
            pos1 = pos3 - e.clientX;
            pos2 = pos4 - e.clientY;
            pos3 = e.clientX;
            pos4 = e.clientY;
            // Set the element's new position
            element.style.top = (element.offsetTop - pos2) + "px";
            element.style.left = (element.offsetLeft - pos1) + "px";
        }

        function closeDragElement() {
            // Stop moving when mouse button is released
            document.onmouseup = null;
            document.onmousemove = null;
        }
    }
    function toggleTimer() {
        const timer = document.getElementById('timer-container');
        if (timer.style.display === 'none') {
            timer.style.display = 'block';
        } else {
            timer.style.display = 'none';
        }
    }
</script>
    <script type="importmap">
    {
      "imports": {
        "@google/generative-ai": "https://esm.run/@google/generative-ai"
      }
    }
  </script>

    <!-- Script module để nhập và khởi tạo mô hình GenerativeAI -->
    <div id="quiz-container"></div>
    <script type="module">
        import { GoogleGenerativeAI } from "@google/generative-ai";

        // const API_KEY = "AIzaSyAWEPC945637GjSgW6V0WFtwcoA4f4SmKs";
        const API_KEY = "AIzaSyBF01fnqmzq8Kr6WH5l2A0TqEfCgiBY3nc";

        const genAI = new GoogleGenerativeAI(API_KEY);

        let model;
        (async () => {
            model = await genAI.getGenerativeModel({ model: "gemini-1.5-flash" });
        })();

        let text;
        async function run() {
            document.getElementById('loading').innerHTML = `
            <span>Loading...</span>
            <span class="dot">.</span>
            <span class="dot">.</span>
            <span class="dot">.</span>
        `;

            const numQuestions = document.getElementById('num-questions').value;
            const prompt = `Tạo ra chính xác ${numQuestions} câu hỏi quiz với 4 đáp án khả thi mỗi câu, có chủ đề là: ${document.getElementById('prompt').value}. Hãy chắc chắn rằng mỗi câu sẽ chỉ có 1 đáp án đúng. Cấu trúc nó sẽ nên như này: 
        [
          { question: "Câu hỏi 1", answers: [ { text: "Đáp án 1", correct: true/false }, { text: "Đáp án 2", correct: true/false }, { text: "Đáp án 3", correct: true/false }, { text: "Đáp án 4", correct: true/false } ] },
          { question: "Câu hỏi 2", answers: [ { text: "Đáp án 1", correct: true/false }, { text: "Đáp án 2", correct: true/false }, { text: "Đáp án 3", correct: true/false }, { text: "Đáp án 4", correct: true/false } ] },
          { question: "Câu hỏi 3", answers: [ { text: "Đáp án 1", correct: true/false }, { text: "Đáp án 2", correct: true/false }, { text: "Đáp án 3", correct: true/false }, { text: "Đáp án 4", correct: true/false } ] },
        ];`;

            try {
                const result = await model.generateContentStream(prompt);
                const response = await result.response;
                text = await response.text();
                document.getElementById('loading').innerHTML = "Done!";
            } catch (error) {
                console.error("Error generating content:", error);
            }
            console.log(prompt);
        }

        let quizArray; // Biến lưu trữ dữ liệu câu hỏi
        let jsonDataLoaded = false; // Biến cờ để theo dõi xem dữ liệu đã được tải hay chưa

        function get() {
            const stringtext = text.toString();
            console.log(stringtext);
            let jsonData = cleanJsonString(stringtext);
            if (jsonData) {
                quizArray = JSON.parse(jsonData);
                console.log(quizArray);
                console.log(typeof quizArray);
                if (quizArray.length != document.getElementById('num-questions').value) {
                    console.error("The generated quiz does not contain the correct number of questions.");
                }
                renderQuiz(quizArray);
            } else {
                console.error("Failed to clean JSON string");
            }
        }

        function renderQuiz(quizData) {
            const container = document.getElementById('quiz-container');
            container.innerHTML = ''; // Clear previous quiz content
            quizData.forEach((quiz, quizIndex) => {
                const quizDiv = document.createElement('div');
                quizDiv.classList.add('quiz');

                const quizTitle = document.createElement('h3');
                quizTitle.textContent = `Question ${quizIndex + 1}: ${quiz.question}`;
                quizDiv.appendChild(quizTitle);

                const answersDiv = document.createElement('div');
                answersDiv.classList.add('answers');

                quiz.answers.forEach((answer, answerIndex) => {
                    const answerLabel = document.createElement('label');
                    answerLabel.classList.add('answer-item');

                    const radio = document.createElement('input');
                    radio.type = 'radio';
                    radio.name = `quiz${quizIndex}_answer`;
                    radio.value = answerIndex;

                    const answerText = document.createElement('span');
                    answerText.textContent = answer.text;
                    answerLabel.appendChild(radio);
                    answerLabel.appendChild(answerText);

                    const resultText = document.createElement('span');
                    resultText.classList.add('result-text');
                    answerLabel.appendChild(resultText);

                    radio.addEventListener('change', () => {
                        const allLabels = answersDiv.querySelectorAll('label');
                        allLabels.forEach(label => {
                            const resultSpan = label.querySelector('.result-text');
                            if (label === answerLabel) {
                                if (answer.correct) {
                                    resultSpan.textContent = 'Correct!';
                                    resultSpan.classList.add('correct-text');
                                } else {
                                    resultSpan.textContent = 'Wrong!';
                                    resultSpan.classList.add('incorrect-text');
                                }
                            } else {
                                resultSpan.textContent = '';
                                resultSpan.classList.remove('correct-text', 'incorrect-text');
                            }
                        });
                    });

                    answersDiv.appendChild(answerLabel);
                });

                quizDiv.appendChild(answersDiv);
                container.appendChild(quizDiv);
            });
        }

        function cleanJsonString(json) {
            console.log('Original JSON:', json);
            json = json.replace(/```json/g, '').replace(/```/g, '').trim();
            console.log('Cleaned JSON:', json);
            try {
                let parsedJson = JSON.parse(json);
                return JSON.stringify(parsedJson, null, 2);
            } catch (e) {
                console.error("Invalid JSON string", e);
                return null;
            }
        }

        document.getElementById('get').addEventListener('click', get);

        document.getElementById('submit').addEventListener('click', run);

        document.getElementById('prompt').addEventListener('keypress', (event) => {
            if (event.key === 'Enter') {
                event.preventDefault();
                document.getElementById('submit').click();
            }
        });
    </script>
    <!-- <div class="footer">
        <p>&copy; 2024 GAE. All rights reserved.</p>
    </div> -->
</body>

</html>